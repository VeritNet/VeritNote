html, body {
    -webkit-app-region: no-drag;
}

/* --- 1. 设计系统 & 全局样式 --- */
:root {
    /* 颜色 */
    --bg-primary: rgb(24,24,24); /* 主背景 (深灰) */
    --bg-secondary: rgb(27, 27, 28); /* 侧边栏/弹出菜单背景 (调深) */
    --bg-tertiary: #333333; /* 悬停/活动状态背景 */
    --bg-accent: #3a3d41; /* 突出背景，如输入框 */
    --bg-active-item: #3a3d41; /* 新增：侧边栏选中项背景 (亮灰) */
    --bg-save-unsaved: #4a6a8f; /* 新增：保存按钮在未保存状态下的背景 */

    --text-primary: #cccccc; /* 主要文字 (浅灰) */
    --text-secondary: #8c8c8c; /* 次要文字/占位符 */
    --text-accent: #569cd6; /* 链接/高亮文字 (蓝色) */
    --text-on-accent-bg: #ffffff;
    --border-color: #444444; /* 边框颜色 */
    --shadow-color: rgba(0, 0, 0, 0.5);
    /* 字体 */
    --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    --font-family-monospace: "Courier New", Courier, monospace;
    /* 间距 */
    --spacing-xs: 4px;
    --spacing-s: 8px;
    --spacing-m: 16px;
    --spacing-l: 24px;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: var(--font-family);
    background-color: var(--bg-primary);
    color: var(--text-primary);
    font-size: 16px;
    line-height: 1.6;
    overflow: hidden; /* 防止body滚动 */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* --- 2. 整体应用布局 --- */
.app-container {
    display: flex;
    height: 100vh;
}

/* --- 3. 左侧边栏样式 --- */
#sidebar {
    width: 260px; /* Default width */
    min-width: 120px;
    max-width: 650px;
    flex-shrink: 0;
    background-color: var(--bg-secondary);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    transition: width 0.3s ease, transform 0.3s ease, min-width 0.3s ease;
    will-change: width, transform;
    position: relative;
    z-index: 50;
}

#sidebar-resizer {
    position: absolute;
    top: 0;
    right: 0;
    width: 5px;
    height: 100%;
    cursor: col-resize;
    z-index: 60;
}

.sidebar-header {
    padding: var(--spacing-m);
    padding-left: var(--spacing-s);
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
}

    .sidebar-header h3 {
        font-size: 18px;
        font-weight: 600;
    }

.workspace-tree {
    padding: var(--spacing-s);
    overflow-y: auto;
    flex-grow: 1;
}

.loading-placeholder, .empty-workspace {
    color: var(--text-secondary);
    padding: var(--spacing-s);
    font-style: italic;
}

.tree-node {
    padding: var(--spacing-xs) var(--spacing-s);
    margin-bottom: 2px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    user-select: none;
    transition: background-color 0.2s ease;
    gap: var(--spacing-s);
}

    .tree-node:hover {
        background-color: var(--bg-tertiary);
    }

    .tree-node.active {
        background-color: var(--bg-active-item);
        color: var(--text-primary);
    }

    .tree-node .icon {
        width: 16px;
        height: 16px;
        text-align: center;
        flex-shrink: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .tree-node.folder > .icon::before {
        content: '▶';
        font-size: 10px;
        display: inline-block;
        transition: transform 0.2s ease;
    }

    .tree-node.folder.open > .icon::before {
        transform: rotate(90deg);
    }

    .tree-node.page > .icon::before {
        content: '📄';
        font-size: 12px;
    }

.tree-node-children {
    padding-left: var(--spacing-m);
}

.sidebar-footer {
    padding: var(--spacing-s);
    border-top: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-s);
}

#sidebar > .sidebar-footer > .sidebar-footer-btn,
#right-sidebar > .right-sidebar-footer > .sidebar-footer-btn {
    width: 100%;
    background: none;
    border: none;
    color: var(--text-secondary);
    padding: var(--spacing-s);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--spacing-s);
    font-size: 14px;
    text-align: left;
    transition: background-color 0.2s ease, color 0.2s ease; /* Add transition */
    justify-content: flex-start;
}

    #sidebar > .sidebar-footer > .sidebar-footer-btn:hover,
    #right-sidebar > .right-sidebar-footer > .sidebar-footer-btn:hover {
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
    }

#sidebar .sidebar-footer button {
    background-color: var(--bg-accent);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    padding: var(--spacing-s) var(--spacing-m);
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    font-size: 14px;
    transition: background-color 0.2s ease, color 0.2s ease;
    width: 100%;
    text-align: center;
    justify-content: center;
}

    #sidebar .sidebar-footer button:hover {
        background-color: var(--bg-tertiary);
    }

/* --- 左侧边栏折叠/窥视 --- */
.sidebar-collapsed #sidebar {
    width: 0;
    min-width: 0;
    border-right: none;
    transform: translateX(-100%);
    padding: 0;
    overflow: hidden;
    pointer-events: none;
}

    .sidebar-collapsed #sidebar .sidebar-header,
    .sidebar-collapsed #sidebar .workspace-tree,
    .sidebar-collapsed #sidebar .sidebar-footer {
        opacity: 0;
        transition: opacity 0.1s ease;
    }

.sidebar-collapsed.sidebar-peek #sidebar {
    width: 260px;
    min-width: 260px;
    transform: translateX(0);
    border-right: 1px solid var(--border-color);
    box-shadow: 5px 0 15px rgba(0,0,0,0.2);
    pointer-events: auto;
}

    .sidebar-collapsed.sidebar-peek #sidebar .sidebar-header,
    .sidebar-collapsed.sidebar-peek #sidebar .workspace-tree,
    .sidebar-collapsed.sidebar-peek #sidebar .sidebar-footer {
        opacity: 1;
        transition: opacity 0.2s ease 0.1s;
    }

#sidebar-peek-trigger {
    position: fixed;
    top: 0;
    left: 0;
    width: 10px;
    height: 100vh;
    z-index: 100;
}

.app-container:not(.sidebar-collapsed) #sidebar-peek-trigger {
    display: none;
}

/* ==========================================================================
   4. 主内容区布局 (重构)
   ========================================================================== */

#main-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column; /* 垂直堆叠: 标题栏, 标签栏, 主体内容 */
    overflow: hidden;
    position: relative;
}

#window-controls {
    position: absolute;
    top: 0;
    right: 0;
    height: 40px;
    display: flex;
    align-items: center;
    z-index: 2000;
    -webkit-app-region: no-drag;
}

.window-control-btn {
    width: 46px;
    height: 100%;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s ease, color 0.2s ease;
}

    .window-control-btn:hover {
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .window-control-btn.danger:hover {
        background-color: #e81123;
        color: white;
    }

.is-fullscreen #maximize-btn {
    pointer-events: none;
    opacity: 0.4;
    cursor: not-allowed;
}

#tab-bar {
    display: flex;
    align-items: center;
    background-color: var(--bg-primary);
    padding: 4px var(--spacing-s) 0 0;
    flex-shrink: 0;
    overflow-x: auto;
    border-bottom: 1px solid var(--border-color);
    -webkit-app-region: drag;
    padding-right: 184px; /* 46px * 4 for window controls */
    min-height: 40px;
    box-sizing: border-box;
}

.is-fullscreen #tab-bar {
    -webkit-app-region: no-drag;
}

#tab-bar::-webkit-scrollbar {
    display: none;
}

#dynamic-tabs-container {
    display: flex;
    align-items: flex-end;
    height: 100%;
}

.tab-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-s);
    padding: 6px 12px;
    border: 1px solid transparent;
    border-bottom: none;
    border-radius: 6px 6px 0 0;
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
    font-size: 13px;
    color: var(--text-secondary);
    position: relative;
    -webkit-app-region: no-drag;
}

    .tab-item:hover {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
    }

    .tab-item.active {
        background-color: var(--bg-secondary);
        border-color: var(--border-color);
        color: var(--text-primary);
    }

    .tab-item.dragging {
        opacity: 0.5;
    }

.unsaved-dot {
    width: 12px;
    height: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

    .unsaved-dot::before {
        content: '';
        display: block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: var(--text-secondary);
        opacity: 0;
        transition: opacity 0.2s ease;
    }

.tab-item.unsaved .unsaved-dot::before {
    opacity: 1;
}

.tab-item.active.unsaved .unsaved-dot::before {
    background-color: var(--text-primary);
}

.tab-close-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 16px;
    line-height: 1;
    padding: 2px;
    border-radius: 50%;
    cursor: pointer;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

    .tab-close-btn:hover {
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
    }

.tab-item.active .unsaved-dot::before {
    display: none;
}

.tab-item.active.unsaved .tab-close-btn {
    background-image: radial-gradient(circle, var(--text-primary) 40%, transparent 45%);
    background-position: center;
    background-repeat: no-repeat;
    color: transparent;
}

    .tab-item.active.unsaved .tab-close-btn:hover {
        color: var(--text-primary);
        background-image: none;
    }

#back-to-dashboard-btn {
    flex-shrink: 0;
    margin: 0 var(--spacing-s) 0 0;
    -webkit-app-region: no-drag;
    position: absolute;
}

/* 核心布局修复: 主体内容区 */
#main-content-body {
    display: flex; /* 水平排列: 编辑器, 右侧边栏 */
    flex-grow: 1; /* 占据所有剩余的垂直空间 */
    overflow: hidden; /* 防止子元素溢出 */
    min-height: 0; /* flexbox hack to ensure children can shrink */
}

#editor-area-container {
    position: relative;
    flex-grow: 1; /* 占据所有剩余的水平空间 */
    overflow: hidden;
    display: flex; /* Make it a flex container to center its children */
    flex-direction: column;
}

.editor-instance-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.editor-view {
    flex-grow: 1;
    overflow-y: auto;
    padding: var(--spacing-m) var(--spacing-l) 15vh;
    max-width: 900px;
    margin: 0 auto;
    width: 100%;
}

#no-file-message {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-secondary);
    font-size: 18px;
    user-select: none;
}

/* ==========================================================================
   5. Block 核心样式 (Core Block Styles)
   ========================================================================== */

.block-container {
    position: relative;
    padding-left: 28px;
    margin-bottom: var(--spacing-xs);
    display: flex;
    flex-direction: column;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    border-top-right-radius: 4px;
    border-bottom-right-radius: 4px;
}

    .block-container.is-selected {
        background-color: rgba(86, 156, 214, 0.12) !important;
        box-shadow: inset 2px 0 0 0 var(--text-accent);
    }

.block-controls {
    position: absolute;
    top: 2px;
    left: 24px;
    transform: translateX(-100%);
    display: flex;
    align-items: center;
    opacity: 0;
    transition: opacity 0.2s ease;
    z-index: 10;
    gap: 4px;
}

.block-container:hover > .block-controls {
    opacity: 1;
}

.drag-handle, .delete-btn {
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px;
    z-index: 2;
}

.drag-handle {
    cursor: grab;
}

    .drag-handle:active {
        cursor: grabbing;
    }

.delete-btn:hover {
    color: #f44336;
}

.block-content {
    outline: none;
    min-height: 26px;
    width: 100%;
    padding: 2px 0;
    overflow-wrap: break-word;
    word-break: break-word;
}

.drop-indicator {
    height: 2px;
    background-color: var(--text-accent);
    pointer-events: none;
    z-index: 100;
    /* No position: absolute needed anymore */
}

.drop-indicator-vertical {
    position: absolute;
    top: 0;
    width: 2px;
    background-color: var(--text-accent);
    pointer-events: none;
    z-index: 100;
}

/* --- NEW: Quadrant Overlay Styles --- */
.quadrant-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 90; /* Below the drop indicators */
    overflow: hidden; /* Ensure lines don't bleed out */
}

.quadrant-line-h, .quadrant-line-v {
    position: absolute;
    background-color: rgba(140, 140, 140, 0.3); /* Faint gray line */
    pointer-events: none;
}

.quadrant-line-h {
    top: 50%;
    left: 0;
    width: 100%;
    height: 1px;
    transform: translateY(-50%);
}

.quadrant-line-v {
    left: 50%;
    top: 0;
    height: 100%;
    width: 1px;
    transform: translateX(-50%);
}

.quadrant-bg {
    position: absolute;
    background-color: rgba(86, 156, 214, 0.1); /* Faint blue background */
    opacity: 0;
    transition: opacity 0.15s ease-in-out;
    will-change: opacity;
}

    .quadrant-bg.active {
        opacity: 1; /* Show only the active quadrant's background */
    }

    .quadrant-bg[data-quadrant="top"] {
        top: 0;
        left: 0;
        width: 100%;
        height: 50%;
    }

    .quadrant-bg[data-quadrant="bottom"] {
        bottom: 0;
        left: 0;
        width: 100%;
        height: 50%;
    }

    .quadrant-bg[data-quadrant="left"] {
        top: 0;
        left: 0;
        width: 15%; /* Corresponds to the JS xZone value */
        height: 100%;
    }

    .quadrant-bg[data-quadrant="right"] {
        top: 0;
        right: 0;
        width: 15%; /* Corresponds to the JS xZone value */
        height: 100%;
    }

/* ** Hover effect for ALL block types ** */
.block-container:hover > .block-content,
.block-container:hover > .block-container > .block-content { /* For nested containers */
    background-color: rgba(255, 255, 255, 0.06);
}

    /* Special case: Don't apply the generic hover effect to Columns containers,
   as it can look strange. Their children columns will get the effect instead. */
    .block-container:hover > .block-content[data-type="columns"] {
        background-color: transparent;
    }

/* --- Style for multi-drag ghost elements --- */
.block-container.is-dragging-ghost {
    opacity: 0.5;
    background-color: var(--bg-tertiary);
}

    /* Make the actually dragged element slightly more prominent than the other ghosts */
    .block-container.is-dragging-ghost:hover {
        opacity: 0.6;
    }

/* ==========================================================================
   6. 特定 Block 类型样式
   ========================================================================== */
.block-content[data-placeholder]:empty::before {
    content: attr(data-placeholder);
    color: var(--text-secondary);
    cursor: text;
    pointer-events: none;
    display: none;
}

.block-content[data-placeholder]:empty:focus::before {
    display: inline;
}

.block-content[data-type="heading1"] {
    font-size: 2.5em;
    font-weight: 800;
    line-height: 1.2;
    margin-top: 1em;
    margin-bottom: 0.5em;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 0.3em;
}

.block-content[data-type="heading2"] {
    font-size: 1.8em;
    font-weight: 700;
    line-height: 1.3;
    margin-top: 0.8em;
    margin-bottom: 0.4em;
}

a {
    color: var(--text-accent);
    text-decoration: none;
}

    a:hover {
        text-decoration: underline;
    }

.block-content[data-type="image"] img {
    max-width: 100%;
    border-radius: 4px;
}

.image-placeholder {
    width: 100%;
    background: var(--bg-accent);
    border: 2px dashed var(--border-color);
    padding: var(--spacing-l);
    text-align: center;
    color: var(--text-secondary);
    border-radius: 4px;
    cursor: pointer;
}

.block-content[data-type="linkButton"] a {
    display: inline-block;
    background-color: var(--bg-accent);
    border: 1px solid var(--border-color);
    padding: var(--spacing-s) var(--spacing-m);
    border-radius: 4px;
    text-decoration: none;
    transition: background-color 0.2s ease;
}

    .block-content[data-type="linkButton"] a:hover {
        background-color: var(--bg-tertiary);
    }

.block-content[data-type="callout"] {
    background-color: rgba(86, 156, 214, 0.1);
    border: 1px solid rgba(86, 156, 214, 0.2);
    border-radius: 4px;
    display: flex;
    position: relative;
    min-height: 50px;
    padding: var(--spacing-s);
}

.callout-icon {
    margin-right: var(--spacing-s);
    font-size: 1.2em;
    user-select: none;
    padding-top: var(--spacing-s);
}

.callout-content-wrapper.block-children-container {
    flex-grow: 1;
    min-width: 0;
    padding: var(--spacing-s);
    min-height: 100%;
}

.block-children-container:empty {
    min-height: 24px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
}

    .block-children-container:empty:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }


/* --- Quote Block Styles --- */
.block-content[data-type="quote"] {
    margin: var(--spacing-s) 0;
    transition: all 0.2s ease;
}

    .block-content[data-type="quote"][data-style="default"] {
        border-left: 3px solid var(--text-primary);
        padding-left: var(--spacing-m);
    }

    .block-content[data-type="quote"][data-style="plain"] {
        border-left: 3px solid transparent;
        padding-left: 0;
    }


.quote-preview-container {
    min-height: 26px;
}

    /* By default, nothing inside the preview is interactive */
    .quote-preview-container * {
        pointer-events: none !important;
        user-select: none !important;
    }

/* The only exception is if the entire quote block is a single clickable link */
.quote-click-wrapper {
    pointer-events: auto !important;
}

    /* If the whole quote is a link, we need to re-enable pointer events on its direct children
   so that text and other elements inside it are part of the clickable area. */
    .quote-click-wrapper > * {
        pointer-events: auto !important;
    }

    /* However, even if the whole block is a link, we STILL disable any nested links inside it.
   A link within a link is bad practice and confusing. */
    .quote-click-wrapper a {
        pointer-events: none !important;
    }


.quote-empty-placeholder, .quote-loading-placeholder, .quote-error-placeholder {
    width: 100%;
    background: var(--bg-accent);
    border: 2px dashed var(--border-color);
    padding: var(--spacing-l);
    text-align: center;
    color: var(--text-secondary);
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
}

.quote-error-placeholder {
    border-color: #e81123;
    color: #ff8a8a;
}

.quote-click-wrapper {
    display: block;
    text-decoration: none;
    color: inherit;
    border-radius: 4px;
    transition: background-color 0.2s ease;
    pointer-events: auto;
}

    .quote-click-wrapper:hover {
        background-color: var(--bg-tertiary);
        text-decoration: none;
    }


.block-content[data-type="column"]:empty {
    min-height: 40px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
}

    .block-content[data-type="column"]:empty:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }

.block-content[data-type="columns"] {
    display: flex;
    width: 100%;
    margin: 0 calc(var(--spacing-m) / -2);
}

.block-content[data-type="column"] {
    min-width: 80px;
    flex-shrink: 0;
    padding: 0 calc(var(--spacing-m) / 2);
    position: relative;
    padding-bottom: 24px;
    min-height: 40px;
}

.column-resizer {
    width: var(--spacing-m);
    margin: 0 calc(var(--spacing-m) / -2);
    cursor: col-resize;
    z-index: 10;
    position: relative;
    flex-shrink: 0;
}

    .column-resizer:hover::after {
        content: '';
        position: absolute;
        left: calc(50% - 1px);
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: var(--text-accent);
    }
/* ==========================================================================
   7. "/" 命令菜单样式
   ========================================================================== */
.command-menu {
    position: absolute;
    width: 320px;
    border-radius: 8px;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    z-index: 1000;
    overflow: hidden;
    background: rgba(45, 45, 45, 0.75);
    backdrop-filter: blur(12px) saturate(180%);
    -webkit-backdrop-filter: blur(12px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.18);
}

.command-menu-title {
    padding: var(--spacing-s) var(--spacing-m);
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
}

.command-menu-list {
    max-height: 300px;
    overflow-y: auto;
    padding: 0 var(--spacing-xs) var(--spacing-xs) var(--spacing-xs);
}

.command-item {
    display: flex;
    align-items: center;
    padding: var(--spacing-s);
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

    .command-item:hover, .command-item.selected {
        background-color: rgba(255, 255, 255, 0.1);
    }

.command-item-icon {
    font-size: 20px;
    width: 36px;
    height: 36px;
    flex-shrink: 0;
    margin-right: var(--spacing-m);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    background-color: rgba(255, 255, 255, 0.05);
}

.command-item-text {
    display: flex;
    flex-direction: column;
}

    .command-item-text strong {
        font-weight: 500;
        color: var(--text-primary);
        line-height: 1.2;
    }

    .command-item-text small {
        color: var(--text-secondary);
        font-size: 12px;
        line-height: 1.2;
    }

/* ==========================================================================
   8. 自定义滚动条
   ========================================================================== */
::-webkit-scrollbar {
    width: 14px;
    height: 14px;
}

::-webkit-scrollbar-track {
    background: transparent;
}

::-webkit-scrollbar-thumb {
    background-color: var(--bg-accent);
    border-radius: 10px;
    border: 4px solid var(--bg-primary);
}

    ::-webkit-scrollbar-thumb:hover {
        background-color: #555;
    }

#sidebar ::-webkit-scrollbar-thumb,
#right-sidebar ::-webkit-scrollbar-thumb {
    border-color: var(--bg-secondary);
}

/* ==========================================================================
   9. 交互式浮动元素 (Interactive Overlays)
   ========================================================================== */
.context-menu {
    position: absolute;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 4px 12px var(--shadow-color);
    padding: var(--spacing-xs);
    width: 180px;
    z-index: 2000;
    user-select: none;
}

.context-menu-item {
    padding: var(--spacing-s) var(--spacing-m);
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s ease;
}

    .context-menu-item:hover {
        background-color: var(--bg-tertiary);
    }

    .context-menu-item.danger:hover {
        background-color: #5c2323;
        color: #ff8a8a;
    }

    .context-menu-item.separator {
        height: 1px;
        background-color: var(--border-color);
        margin: var(--spacing-xs) 0;
        padding: 0;
    }

.export-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3000;
}

.export-modal, .cook-settings-content {
    background-color: var(--bg-secondary);
    padding: var(--spacing-l);
    border-radius: 8px;
    box-shadow: 0 8px 24px var(--shadow-color);
    width: 400px;
}

    .export-modal h3 {
        margin-bottom: var(--spacing-m);
    }

.progress-bar-container {
    width: 100%;
    height: 8px;
    background-color: var(--bg-accent);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: var(--spacing-s);
}

.progress-bar {
    width: 0%;
    height: 100%;
    background-color: var(--text-accent);
    transition: width 0.2s ease;
}

#cancel-export-btn {
    background-color: var(--bg-accent);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    padding: var(--spacing-s) var(--spacing-m);
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    font-size: 14px;
    transition: background-color 0.2s ease;
    width: auto; /* Allow it to size to content */
    margin: 0 auto; /* Center it */
}

    #cancel-export-btn:hover {
        background-color: var(--bg-tertiary);
    }

#export-status {
    font-size: 14px;
    color: var(--text-secondary);
}

.cook-settings-content {
    width: 500px;
    max-width: 95vw;
}

    .cook-settings-content h3 {
        text-align: center;
        margin-bottom: var(--spacing-l);
    }

.cook-options-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-m);
    margin-bottom: var(--spacing-l);
}

.cook-option {
    display: flex;
    align-items: center;
    gap: var(--spacing-s);
    font-size: 14px;
}

    .cook-option input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: var(--text-accent);
    }

.cook-settings-footer {
    display: flex;
    justify-content: flex-end;
    gap: var(--spacing-s);
    margin-top: var(--spacing-l);
}

    .cook-settings-footer button {
        width: auto;
        background-color: var(--bg-accent);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        padding: var(--spacing-s) var(--spacing-m);
        border-radius: 4px;
        cursor: pointer;
        font-family: inherit;
        font-size: 14px;
        transition: background-color 0.2s ease;
    }

        .cook-settings-footer button:hover {
            background-color: var(--bg-tertiary);
        }

        .cook-settings-footer button.primary-btn {
            background-color: var(--text-accent);
            border-color: var(--text-accent);
            color: var(--text-on-accent-bg);
        }

            .cook-settings-footer button.primary-btn:hover {
                background-color: #6ba1d4;
            }

/* ==========================================================================
   10. 悬浮工具栏与弹出框 (Floating Toolbar & Popovers)
   ========================================================================== */
#floating-toolbar {
    position: absolute;
    bottom: var(--spacing-m);
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: var(--spacing-s);
    background: rgba(45, 45, 45, 0.75);
    backdrop-filter: blur(12px) saturate(180%);
    -webkit-backdrop-filter: blur(12px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.18);
    padding: var(--spacing-xs) var(--spacing-s);
    border-radius: 50px;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    will-change: transform;
}

#toolbar-peek-trigger {
    position: absolute;
    bottom: 100%; /* Position it right above the toolbar */
    left: 0;
    width: 100%;
    height: 20px; /* A fixed, reliable height */
    z-index: 999;
}

#main-content.toolbar-collapsed #floating-toolbar {
    transform: translate(-50%, calc(100% + var(--spacing-m)));
}

#main-content.toolbar-collapsed.toolbar-peek #floating-toolbar {
    transform: translateX(-50%);
}

#toggle-toolbar-btn svg {
    transition: transform 0.3s ease;
}

#main-content.toolbar-collapsed #toggle-toolbar-btn svg {
    transform: rotate(180deg);
}

.toolbar-icon-btn {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: var(--spacing-s);
    border-radius: 6px;
    transition: background-color 0.2s, color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
}

    .toolbar-icon-btn:hover {
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .toolbar-icon-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background-color: transparent;
    }

#save-btn.unsaved {
    background-color: var(--bg-save-unsaved);
    color: var(--text-on-accent-bg);
}

    #save-btn.unsaved:hover {
        background-color: #5a7ea8;
    }

.mode-toggle {
    display: flex;
    align-items: center;
    position: relative;
    background-color: var(--bg-primary);
    border-radius: 8px;
    padding: 2px;
    height: 36px;
}

.mode-toggle-option {
    padding: var(--spacing-xs);
    z-index: 2;
    cursor: pointer;
    color: var(--text-secondary);
    transition: color 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
}

.mode-toggle.edit-active .mode-toggle-option[data-mode="edit"],
.mode-toggle.preview-active .mode-toggle-option[data-mode="preview"] {
    color: var(--text-primary);
}

.mode-toggle-slider {
    position: absolute;
    top: 2px;
    bottom: 2px;
    left: 2px;
    width: calc(50% - 2px);
    background-color: var(--bg-tertiary);
    border-radius: 6px;
    transition: left 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    z-index: 1;
}

.mode-toggle.preview-active .mode-toggle-slider {
    left: calc(50% + 2px);
}

#block-toolbar-grace-area {
    position: absolute;
    /* background-color: rgba(255, 0, 0, 0.2); */ /* For debugging visuals */
    z-index: 999; /* Just below the toolbar itself */
    pointer-events: auto; /* It must capture mouse events */
}

#block-toolbar {
    position: absolute;
    display: flex;
    align-items: center;
    background: rgba(45, 45, 45, 0.75);
    backdrop-filter: blur(12px) saturate(180%);
    -webkit-backdrop-filter: blur(12px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.18);
    border-radius: 6px;
    box-shadow: 0 4px 12px var(--shadow-color);
    padding: var(--spacing-xs);
    z-index: 1000;
}

.toolbar-button {
    background: none;
    border: none;
    color: var(--text-primary);
    padding: var(--spacing-xs) var(--spacing-s);
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    line-height: 1.2;
    transition: background-color 0.2s ease;
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
}

    .toolbar-button:hover {
        background-color: var(--bg-tertiary);
    }

    .toolbar-button.active {
        background-color: var(--text-accent);
        color: var(--text-on-accent-bg);
    }

/* --- Popover Styles for Dynamic Content --- */

.popover {
    position: absolute;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 4px 12px var(--shadow-color);
    z-index: 1001;
    width: 320px;
}

.popover-content {
    padding: var(--spacing-s);
}

/* Generic input style for any popover */
.popover input[type="text"] {
    width: 100%;
    background-color: var(--bg-accent);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    border-radius: 4px;
    padding: var(--spacing-s);
    outline: none;
    box-sizing: border-box;
}

    .popover input[type="text"]:focus {
        border-color: var(--text-accent);
    }

/* Generic button style for any popover */
.popover-button {
    width: 100%;
    margin-top: var(--spacing-s);
    padding: var(--spacing-s);
    background-color: var(--bg-accent);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: inherit;
    font-size: 14px;
    cursor: pointer;
    text-align: center;
    transition: background-color 0.2s ease;
}

    .popover-button:hover {
        background-color: var(--bg-tertiary);
    }

/* Generic search results style for any popover */
.popover-search-results {
    max-height: 150px;
    overflow-y: auto;
    margin-top: var(--spacing-s);
}

/* Specific adjustment for reference popover search results */
#ref-popover-page-content .popover-search-results {
    margin-top: 0;
}

.search-result-item {
    padding: var(--spacing-s);
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

    .search-result-item:hover {
        background-color: var(--bg-tertiary);
    }

.language-item {
    padding: var(--spacing-s) var(--spacing-m);
    cursor: pointer;
    border-radius: 4px;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: background-color 0.2s ease;
}

    .language-item:hover, .language-item.selected {
        background-color: var(--bg-tertiary);
    }


/* Generic color picker style */
.popover-color-picker {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: var(--spacing-s);
}

.color-swatch {
    width: 100%;
    height: 28px;
    border-radius: 4px;
    cursor: pointer;
    border: 2px solid transparent;
}

    .color-swatch:hover {
        border-color: var(--text-primary);
    }

/* ==========================================================================
   11. 列表项样式
   ========================================================================== */
.block-content[data-type="bulletedListItem"],
.block-content[data-type="todoListItem"],
.block-content[data-type="numberedListItem"],
.block-content[data-type="toggleListItem"] {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-xs);
}

.bullet-point {
    line-height: 1.6;
    user-select: none;
}

.todo-checkbox-wrapper {
    padding-top: 5px;
}

.list-item-content-wrapper {
    flex-grow: 1;
}

.list-item-text-area {
    outline: none;
    min-height: 26px;
}

.list-item-children-container {
    height: auto;
    overflow: hidden;
    transition: min-height 0.2s ease-out;
}

    .list-item-children-container:not(:empty) {
        padding-left: 28px;
        padding-top: var(--spacing-xs);
        padding-bottom: 12px;
        min-height: 24px;
    }

    .list-item-children-container:empty {
        min-height: 0;
    }

.block-container.vn-active .list-item-children-container:empty {
    min-height: 24px;
}

.todo-checkbox {
    -webkit-appearance: none;
    appearance: none;
    background-color: transparent;
    margin: 0;
    font: inherit;
    color: var(--text-secondary);
    width: 1.15em;
    height: 1.15em;
    border: 0.15em solid currentColor;
    border-radius: 0.15em;
    transform: translateY(-0.075em);
    display: grid;
    place-content: center;
    cursor: pointer;
}

    .todo-checkbox::before {
        content: "";
        width: 0.65em;
        height: 0.65em;
        transform: scale(0);
        transition: 120ms transform ease-in-out;
        box-shadow: inset 1em 1em var(--text-accent);
        transform-origin: bottom left;
        clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
    }

    .todo-checkbox:checked::before {
        transform: scale(1);
    }

.list-item-text-area.todo-checked {
    text-decoration: line-through;
    color: var(--text-secondary);
}

.number-point-wrapper {
    display: flex;
    align-items: baseline;
    gap: 2px;
    line-height: 1.6;
    user-select: none;
    color: var(--text-secondary);
}

.number-point {
    outline: none;
    min-width: 1em;
    text-align: right;
}

.toggle-triangle-wrapper {
    padding-top: 5px;
    flex-shrink: 0;
}

.toggle-triangle {
    width: 1.15em;
    height: 1.15em;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

    .toggle-triangle::before {
        content: '';
        border-style: solid;
        border-width: 4px 0 4px 6px;
        border-color: transparent transparent transparent var(--text-secondary);
        transform: rotate(90deg);
        transition: transform 0.2s ease-in-out;
    }

.block-content.is-collapsed .toggle-triangle::before {
    transform: rotate(0deg);
}

.block-content.is-collapsed .list-item-children-container {
    max-height: 0;
    min-height: 0;
    padding-top: 0;
    padding-bottom: 0;
    margin-top: 0;
    margin-bottom: 0;
}

.list-item-children-container {
    transition: max-height 0.3s ease-out, padding 0.3s ease-out, margin 0.3s ease-out;
    overflow: hidden;
    max-height: 2000px;
}


/* ==========================================================================
   12. SIDEBARS & PEEK LOGIC (FINAL & MIRRORED)
   ========================================================================== */

/* --- A. Right Sidebar Structure --- */
#right-sidebar {
    width: 280px;
    min-width: 120px;
    max-width: 650px;
    flex-shrink: 0;
    background-color: var(--bg-secondary);
    border-left: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    transition: width 0.3s ease, min-width 0.3s ease, transform 0.3s ease;
    will-change: width, min-width, transform;
    position: relative;
    z-index: 40;
}

#right-sidebar-resizer {
    position: absolute;
    top: 0;
    left: 0;
    width: 5px;
    height: 100%;
    cursor: col-resize;
    z-index: 45;
}

.right-sidebar-header, .right-sidebar-footer {
    flex-shrink: 0;
}

.right-sidebar-header {
    padding: var(--spacing-s);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: center;
}

#right-sidebar-content {
    flex-grow: 1;
    position: relative;
}

.right-sidebar-footer {
    padding: var(--spacing-s);
    border-top: 1px solid var(--border-color);
    display: flex;
}

/* --- B. Collapse Logic (Mirrors Left Sidebar) --- */
/* The class is now on .app-container */
.app-container.right-sidebar-collapsed #right-sidebar {
    width: 0 !important;
    min-width: 0 !important;
    transform: translateX(100%);
    border-left: none;
}

    .app-container.right-sidebar-collapsed #right-sidebar > * {
        opacity: 0;
        pointer-events: none;
    }

/* --- C. Peek Trigger (Mirrors Left Sidebar) --- */
#right-sidebar-peek-trigger {
    position: fixed;
    top: 0;
    right: 0;
    width: 10px;
    height: 100vh;
    z-index: 100;
}
/* Hide trigger when sidebar is open */
.app-container:not(.right-sidebar-collapsed) #right-sidebar-peek-trigger {
    display: none;
}


/* --- D. Peek Effect (Mirrors Left Sidebar) --- */
/* The class is now on .app-container */
.app-container.right-sidebar-peek #right-sidebar {
    width: 280px !important;
    min-width: 280px !important;
    transform: translateX(0);
    border-left: 1px solid var(--border-color);
    box-shadow: -5px 0 15px rgba(0,0,0,0.2);
    z-index: 95;
}

    .app-container.right-sidebar-peek #right-sidebar > * {
        opacity: 1;
        pointer-events: auto;
        transition: opacity 0.2s ease 0.1s;
    }

/* --- E. Reference View & Dragging Styles --- */
#right-sidebar-content {
    transition: background-color 0.2s ease-in-out;
}

body.is-dragging-block #references-view.active {
    background-color: rgba(86, 156, 214, 0.05);
    transition: background-color 0.2s ease-in-out;
}

    body.is-dragging-block #references-view.active.drag-over {
        background-color: rgba(86, 156, 214, 0.15) !important;
        transition: background-color 0.2s ease-in-out;
    }

.reference-item-drop-indicator {
    height: 3px;
    background-color: var(--text-accent);
    margin-top: -2px;
    margin-bottom: -1px;
    pointer-events: none;
}

/* --- F. Remaining Styles --- */
#right-sidebar-view-toggle {
    display: inline-flex;
    align-items: center;
    background-color: var(--bg-primary);
    border-radius: 8px;
    padding: 2px;
    position: relative;
}

.rs-view-option {
    padding: 4px; /* Use padding for spacing, not gap */
    z-index: 2; /* Ensure icons are above the slider */
    cursor: pointer;
    color: var(--text-secondary);
    transition: color 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px; /* Give it a fixed width */
    height: 32px; /* Give it a fixed height */
    border-radius: 6px;
}

    .rs-view-option.active {
        color: var(--text-primary);
    }

.rs-view {
    display: none;
    padding: var(--spacing-s);
    height: 100%;
    overflow-y: auto; /* Each view scrolls independently */
}

    .rs-view.active {
        display: block;
    }

.rs-view-slider {
    position: absolute;
    top: 2px;
    bottom: 2px;
    left: 2px; /* Starts at the first item's position */
    width: 32px; /* Matches the width of one option */
    background-color: var(--bg-tertiary);
    border-radius: 6px;
    transition: left 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    z-index: 1; /* Sits below the icons */
}

.empty-references-placeholder {
    color: var(--text-secondary);
    padding: var(--spacing-m);
    font-style: italic;
    text-align: center;
    font-size: 14px;
}

.reference-item {
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: var(--spacing-s);
    margin-bottom: var(--spacing-s);
    cursor: grab;
    position: relative;
    user-select: none;
}

    .reference-item:active {
        cursor: grabbing;
    }

    .reference-item.dragging {
        opacity: 0.5;
    }

.reference-item-title {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: var(--spacing-s);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding-right: 20px;
}

.reference-item-preview {
    max-height: 80px;
    overflow: hidden;
    pointer-events: none;
    padding: var(--spacing-xs);
    border-radius: 4px;
}

    .reference-item-preview .block-controls {
        display: none !important;
    }

.reference-item-delete-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 20px;
    height: 20px;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    line-height: 1;
    opacity: 0;
    transition: opacity 0.2s, background-color 0.2s;
}

.reference-item:hover .reference-item-delete-btn {
    opacity: 1;
}

.reference-item-delete-btn:hover {
    background-color: var(--bg-tertiary);
    color: var(--text-primary);
}


/* ==========================================================================
   14. POPOVER REVISIONS FOR BLOCK LINKING
   ========================================================================== */
#popover-link-mode-toggle {
    display: flex;
    padding: var(--spacing-xs);
    border-bottom: 1px solid var(--border-color);
}

.popover-mode-btn {
    flex: 1;
    background: none;
    border: none;
    padding: var(--spacing-s);
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 500;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s, color 0.2s;
}

    .popover-mode-btn:hover {
        background-color: var(--bg-tertiary);
    }

    .popover-mode-btn.active {
        background-color: var(--bg-accent);
        color: var(--text-primary);
    }

.popover-instruction {
    font-size: 14px;
    color: var(--text-secondary);
    text-align: center;
    padding: var(--spacing-s);
}

/* --- Block Linking Active State --- */
body.is-linking-block #references-view.active {
    background-color: var(--bg-accent);
    box-shadow: inset 0 0 10px rgba(86, 156, 214, 0.3);
    transition: background-color 0.2s ease-in-out;
}

body.is-linking-block .reference-item {
    cursor: pointer;
    transition: transform 0.2s ease, background-color 0.2s ease;
}

    body.is-linking-block .reference-item:hover {
        background-color: var(--bg-tertiary);
        transform: scale(1.02);
    }

/* --- Block Highlight Style --- */
.block-container.is-highlighted {
    background-color: rgba(247, 209, 84, 0.15) !important;
    box-shadow: inset 3px 0 0 0 #F7D154;
    transition: background-color 0.3s ease;
}

.current-link-display {
    margin-top: var(--spacing-s);
    padding: var(--spacing-xs) var(--spacing-s);
    font-size: 12px;
    background-color: var(--bg-accent);
    color: var(--text-secondary);
    border-radius: 4px;
    word-break: break-all; /* Allow long paths to wrap */
}

#popover-page-content #popover-input[style*="display: none"] + #popover-local-file-btn {
    display: none;
}

#popover-page-content #popover-input[style*="display: none"] ~ .popover-search-results {
    margin-top: 0; /* Remove top margin when input is hidden */
}


/* ==========================================================================
   15. Details Panel Styles
   ========================================================================== */

.empty-details-placeholder {
    color: var(--text-secondary);
    padding: var(--spacing-m);
    font-style: italic;
    text-align: center;
    font-size: 14px;
    user-select: none;
}

.details-panel-section {
    /* REMOVED: background-color and border */
    padding: var(--spacing-s);
    margin-bottom: var(--spacing-s);
}

    /* ADDED: Add a divider between sections when multiple blocks are selected */
    .details-panel-section + .details-panel-section {
        border-top: 2px solid var(--border-color);
        padding-top: var(--spacing-m);
        margin-top: var(--spacing-m);
    }

.details-section-header {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--spacing-m); /* Increased margin */
    text-transform: uppercase; /* As requested */
    letter-spacing: 0.5px;
}

.details-property {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px; /* Slightly larger for readability */
    padding: var(--spacing-xs) 0;
    margin-bottom: var(--spacing-s); /* Space out properties */
}

.details-property-label {
    color: var(--text-secondary);
    flex-shrink: 0;
    margin-right: var(--spacing-s);
}

.details-property-value {
    color: var(--text-primary);
    background-color: var(--bg-accent);
    padding: 3px 7px; /* Fine-tuned padding */
    border-radius: 4px;
    max-width: 75%; /* Allow a bit more space */
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    text-transform: capitalize; /* "paragraph" -> "Paragraph" */
}

    /* ADDED: Specific style for monospaced values like IDs */
    .details-property-value.is-monospace {
        font-family: var(--font-family-monospace);
        text-transform: none; /* Don't capitalize IDs */
    }